Macro.add("dialog",{tags:null,handler:function(){var e=this.payload[0].contents?this.payload[0].contents:"",t=0<this.args.length?this.args[0]:"",r=1<this.args.length?this.args.slice(1).flatten():[];r.push("macro-"+this.name),Dialog.setup(t,r.join(" ")),Dialog.wiki(e),Dialog.open()}}),Macro.add("popup",{handler:function(){if(this.args.length<1)return this.error("need at least one argument; the passage to display");if(!Story.has(this.args[0]))return this.error("the passage "+this.args[0]+"does not exist");var e=this.args[0],t=1<this.args.length?this.args[1]:"",r=2<this.args.length?this.args.slice(2).flatten():[];r.push("macro-"+this.name),Dialog.setup(t,r.join(" ")),Dialog.wiki(Story.get(e).processText()),Dialog.open()}}),Macro.add("dropdown",{handler:function(){if(this.args.length<2){var e=[];return this.args.length<1&&e.push("variable name"),this.args.length<2&&e.push("list values"),this.error("no "+e.join(" or ")+" specified")}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');Config.debug&&this.debugView.modes({block:!0});for(var r=Util.slugify(t),a=this.args.slice(1).flatten(),s=Wikifier.getValue(t),n=0,i=document.createElement("select"),o=0;o<a.length;++o){var l=a[o];String(l)===s&&(n=o),jQuery(document.createElement("option")).text(l).appendTo(i)}jQuery(i).val(a[n]).attr({id:this.name+"-"+r,name:this.name+"-"+r,tabindex:0}).addClass("macro-"+this.name).on("change",function(){Wikifier.setValue(t,this.value)}).appendTo(this.output),Wikifier.setValue(t,a[n])}}),Macro.add("fadein",{tags:null,handler:function(){var e,t,r=$(document.createElement("span")),a=this.payload[0].contents;if(0===this.args.length)return this.error("no arguments given");e=Util.fromCssTime(this.args[0]),t=1<this.args.length?Util.fromCssTime(this.args[1]):0,r.wiki(a).addClass("macro-"+this.name).appendTo(this.output).hide().delay(t).fadeIn(e)}}),Macro.add("fadeout",{tags:null,handler:function(){var e,t,r=$(document.createElement("span")),a=this.payload[0].contents;if(0===this.args.length)return this.error("no arguments given");e=Util.fromCssTime(this.args[0]),t=1<this.args.length?Util.fromCssTime(this.args[1]):0,r.wiki(a).addClass("macro-"+this.name).appendTo(this.output).delay(t).fadeOut(e)}}),setup.fullscreen=function(e){e.requestFullScreen?e.requestFullScreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen&&e.webkitRequestFullScreen()},Macro.add("fullscreen",{handler:function(){var e=$("body").css("background-color");$("html").css("background-color",e),setup.fullscreen(document.documentElement)}}),Macro.add("fullscreenlink",{handler:function(){var e,t,r=$(document.createElement("span")),a=$(document.createElement("a")),s="macro-"+this.name;if(1!==this.args.length)return this.error("incorrect number of arguments");t=this.args[0],a.wiki(t).attr("id","fullscreen-macro-link").ariaClick(function(){e=$("body").css("background-color"),$("html").css("background-color",e),setup.fullscreen(document.documentElement)}),r.append(a).addClass(s).appendTo(this.output)}}),setup.messageMacro={},setup.messageMacro.default="Help",Macro.add("message",{tags:null,handler:function(){var e=this.payload[0].contents,t=$(document.createElement("span")),r=$(document.createElement(this.args.includes("link")?"a":"button")),a=$(document.createElement("span"));r.wiki(0<this.args.length&&"btn"!==this.args[0]?this.args[0]:setup.messageMacro.default).ariaClick(function(){t.hasClass("open")?a.css("display","none").empty():a.css("display","block").wiki(e),t.toggleClass("open")}),t.attr("id","macro-"+this.name+"-"+this.args.join("").replace(/[^A-Za-z0-9]/g,"")).addClass("message-text").append(r).append(a).appendTo(this.output)}}),$(document.body).append("<div id='notify'></div>"),$(document).on(":notify",function(e){e.message&&"string"==typeof e.message&&(e.message.trim(),e.class?"string"==typeof e.class?e.class="open macro-notify "+e.class:Array.isArray(e.class)?e.class="open macro-notify "+e.class.join(" "):e.class="open macro-notify":e.class="open macro-notify",e.delay?("number"!=typeof e.delay&&(e.delay=Number(e.delay)),Number.isNaN(e.delay)&&(e.delay=2e3)):e.delay=2e3,$("#notify").empty().wiki(e.message).addClass(e.class),setTimeout(function(){$("#notify").removeClass()},e.delay))}),Macro.add("notify",{tags:null,handler:function(){var e=this.payload[0].contents,t=!1,r=!1;0<this.args.length&&("number"==typeof this.args[0]?(t=this.args[0],r=1<this.args.length&&this.args.slice(1).flatten()):r=this.args.flatten().join(" ")),$(document).trigger({type:":notify",message:e,delay:t,class:r})}}),setup.operations={tryGlobal:!0,nicknames:!0,fmRange:[0,100]},setup.dice={processDice:function(e,t){var r,a=[],s=0;if("string"==typeof e)a=e.split("d");else if("number"==typeof e&&t)a=[e,t];else{if(!(Array.isArray(e)&&2<=e.length))throw new TypeError("setup.dice.processDice(): could not process arguments...");e.length=2,a=e}for(r=0;r<a[0];r++){s+=Math.floor(Math.random()*a[1])+1}return s},processString:function(e){var t;return[(t=(e=e.trim().replace(/\s/g,"")).match(/(\d*d\d*)(.*)/))[1],Number(t[2])]},roll:function(e,t){if("string"==typeof e){var r=setup.dice.processString(e);return setup.dice.processDice(r[0])+r[1]}return setup.dice.processDice(e,t)}},setup.operations.tryGlobal&&(window.dice=window.dice||setup.dice.roll),Number.prototype.dice||Object.defineProperty(Number.prototype,"dice",{configurable:!0,writable:!0,value:function(e){if(0===this)return 0;if(this<0)throw new TypeError("Number.prototype.dice: cannot roll a negative number of dice!");if(null==e||"number"!=typeof e||e<=0||arguments.length<1)throw new TypeError("Number.prototype.dice: error in argument");if(!Number.isInteger(this)||!Number.isInteger(e))throw new TypeError("Number.prototype.dice: cannot roll partial dice!");return setup.dice.processDice(this,e)}}),Number.prototype.fairmath||Object.defineProperty(Number.prototype,"fairmath",{configurable:!0,writable:!0,value:function(e){var t=setup.operations.fmRange;if(this<t[0]||this>t[1])throw new TypeError("Number.prototype.fairmath called on a number that is out of the defined range (the number was "+this+").");if(null==e||"number"!=typeof e||100<e||e<-100||arguments.length<1)throw new TypeError("Number.prototype.fairmath given incorrect argument or an argument that is out of the valid 0-100 range.");if(0===e)return Math.clamp(Math.trunc(this),t[0],t[1]);if(e<0)return e*=-1,Math.clamp(Math.trunc(this-(this-t[0])*(e/t[1])),t[0],t[1]);if(0<e)return Math.clamp(Math.trunc(this+(t[1]-this)*(e/t[1])),t[0],t[1]);throw new Error("Number.prototype.fairmath encountered an unspecified error.")}}),Math.fairmath||Object.defineProperty(Math,"fairmath",{configurable:!0,writable:!0,value:function(e,t){return e.fairmath(t)}}),setup.operations.nicknames&&(Math.fm||Object.defineProperty(Math,"fm",{configurable:!0,writable:!0,value:function(e,t){return e.fairmath(t)}}),Number.prototype.fm||Object.defineProperty(Number.prototype,"fm",{configurable:!0,writable:!0,value:function(e){return this.fairmath(e)}}),Number.prototype.d||Object.defineProperty(Number.prototype,"d",{configurable:!0,writable:!0,value:function(e){return this.dice(e)}}));